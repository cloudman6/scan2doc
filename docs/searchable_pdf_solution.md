# 使用 JavaScript 生成可复制（Searchable）的 PDF 方案整理

## 一、目标说明

将 **包含文字和图像的扫描图片** 转换为 **可复制、可搜索的 PDF**，要求：

-   PDF 视觉效果与原始图片一致
-   文字可选中 / 可复制 / 可搜索
-   主要使用 JavaScript（Browser 或 Node.js）

------------------------------------------------------------------------

## 二、核心结论（一句话版）

**Searchable PDF 的本质：**

> 原始图片作为视觉背景 + OCR 文字作为 PDF Text Object（通常透明）

------------------------------------------------------------------------

## 三、整体技术路线（推荐）

### 数据前提（你已经具备）

-   原始图片（整图）
-   OCR 结果：
    -   文本内容 + bbox（位置）
    -   图像区域 bbox
-   已能按 bbox 裁剪图像

### 推荐 PDF 生成流程

    创建 PDF 页面
      ↓
    drawImage(原始整图)   ← 打底（视觉）
      ↓
    drawText(OCR 文本)    ← 文字层（功能）

> ✅ 仅这两步，就可以生成 **可复制 PDF**

------------------------------------------------------------------------

## 四、为什么"裁剪图"不是必须的？

### 最小可工作方案（强烈推荐先完成）

-   drawImage(原始整图)
-   drawText(OCR 文本，透明)

即可满足： - 文字可选 - 文字可复制 - 文字可搜索

### 什么时候才需要 drawImage(裁剪图)？

  场景                  是否需要
  --------------------- -----------
  仅做 Searchable PDF   ❌ 不需要
  提升图像清晰度        ✅ 可选
  表格 / 插图增强       ✅
  完全重排 PDF          ✅

------------------------------------------------------------------------

## 五、PDF 库选型建议

### 推荐：pdf-lib

**原因：**

-   浏览器 / Node.js 均可用
-   支持精确坐标绘制
-   支持透明文字
-   支持自定义字体（中文关键）

``` bash
npm install pdf-lib
```

------------------------------------------------------------------------

## 六、PDF 坐标系统（重要）

### 坐标差异

-   OCR / 图片：左上角为原点，y 向下
-   PDF：左下角为原点，y 向上

### y 坐标转换公式

``` ts
pdfY = pageHeight - imgY - height
```

------------------------------------------------------------------------

## 七、文字层实现要点（核心）

### 文字写入示例（pdf-lib）

``` ts
page.drawText(text, {
  x,
  y,
  size: fontSize,
  font,
  opacity: 0.01
})
```

### 注意事项

-   **opacity 不能为 0**（会被优化掉）
-   字体必须支持中文
-   字体大小可由 bbox.height 推算：

``` ts
fontSize ≈ bbox.height * 0.8
```

------------------------------------------------------------------------

## 八、字体建议（中文必看）

推荐字体：

-   Noto Sans CJK
-   思源黑体（Source Han Sans）

必须以 TTF / OTF 形式嵌入 PDF。

------------------------------------------------------------------------

## 九、正确的绘制顺序（非常重要）

### 正确顺序

1.  drawImage(原始整图)
2.  drawText(OCR 文本)

### 错误顺序

-   先 drawText 再 drawImage（文字被遮挡）
-   HTML → Canvas → PDF（文字被栅格化）

------------------------------------------------------------------------

## 十、常见问题排查

  问题             原因
  ---------------- --------------------
  看起来只有图片   未写入 Text Object
  无法选中文字     文字在图片下层
  能选但复制乱码   字体不支持中文
  选区位置错乱     y 坐标未翻转
  PDF 体积过大     drawText 次数过多

------------------------------------------------------------------------

## 十一、推荐的数据结构

``` ts
interface OCRText {
  text: string
  bbox: { x; y; w; h }
}

interface PageData {
  width: number
  height: number
  backgroundImage: Uint8Array
  texts: OCRText[]
}
```

------------------------------------------------------------------------

## 十二、阶段性建议

### 第一阶段（当前）

-   单页 PDF
-   原始图打底
-   OCR 文字透明写入
-   保证：可选 / 可复制 / 中文不乱码

### 第二阶段（进阶）

-   文本行合并
-   置信度过滤
-   图片增强
-   多页 PDF

------------------------------------------------------------------------

## 十三、关键认知总结

-   OCR ≠ 可复制 PDF
-   PDF 是否可选，**只取决于是否存在 Text Object**
-   裁剪图是增强项，不是必要项
-   你当前方案是"专业工具级"的正确路线
